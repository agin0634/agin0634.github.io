<!DOCTYPE html>
<html lang="en">
 <head>
  <!-- Meta Tag -->
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
  <!-- SEO -->
  <meta content="Hi,我是Duri Shen,現職為Unreal Engine Developer." name="description"/>
  <meta content="duri shen" name="author"/>
  <meta content="duri shen" name="copyright"/>
  <meta content="index,follow" name="robots"/>
  <title>
   Duri Shen 開發筆記
  </title>
  <link href="https://agin0634.github.io/web/style/style.css" rel="stylesheet"/>
  <link href="https://agin0634.github.io/web/style/google-code-prettify/prettify.css" rel="stylesheet" type="text/css"/>
  <script src="https://agin0634.github.io/web/style/google-code-prettify/prettify.js" type="text/javascript">
  </script>
  <!-- Favicon -->
  <link href="style/images/favicon/favicon.ico" rel="shortcut icon">
   <link href="style/images/favicon/apple-touch-icon.png" rel="apple-touch-icon" sizes="144x144" type="image/x-icon">
    <!-- All CSS Plugins -->
    <link href="style/css/plugin.css" rel="stylesheet" type="text/css"/>
    <!-- Main CSS Stylesheet -->
    <link href="style/css/style.css" rel="stylesheet" type="text/css"/>
    <!-- Google Web Fonts  -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,300,500,600,700" rel="stylesheet"/>
    <!-- HTML5 shiv and Respond.js support IE8 or Older for HTML5 elements and media queries -->
    <!--[if lt IE 9]>
	   <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
	   <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
   </link>
  </link>
 </head>
 <body onload="PR.prettyPrint()">
  <!-- Preloader Start -->
  <div class="preloader">
   <div class="rounder">
   </div>
  </div>
  <!-- Preloader End -->
  <div id="main">
   <div class="container">
    <div class="row">
     <!-- About Me (Left Sidebar) Start -->
     <div class="col-md-3">
      <div class="about-fixed">
       <div class="my-pic">
        <img alt="" src="style/images/pic/my-pic.png"/>
        <a class="collapsed" data-target="#menu" data-toggle="collapse" href="javascript:void(0)">
         <i class="icon-menu menu">
         </i>
        </a>
        <div class="collapse" id="menu">
         <ul class="menu-link">
          <li>
           <a href="about.html">
            About
           </a>
          </li>
          <li>
           <a href="work.html">
            Work
           </a>
          </li>
          <li>
           <a href="contact.html">
            Contact
           </a>
          </li>
         </ul>
        </div>
       </div>
       <div class="my-detail">
        <div class="white-spacing">
         <h1>
          Duri Shen
         </h1>
         <span>
          Unreal Engine Developer
         </span>
        </div>
        <ul class="social-icon">
         <li>
          <a class="linkedin" href="https://www.linkedin.com/in/shih-che-shen-583837167/" target="_blank">
           <i class="fa fa-linkedin">
           </i>
          </a>
         </li>
         <li>
          <a class="github" href="https://github.com/agin0634" target="_blank">
           <i class="fa fa-github">
           </i>
          </a>
         </li>
        </ul>
       </div>
      </div>
     </div>
     <!-- About Me (Left Sidebar) End -->
     <!-- Blog Post (Right Sidebar) Start -->
     <div class="col-md-9">
      <div class="col-md-12 main-body">
       <div class="row">
        <div class="sub-title">
         <h2>
          My Blog
         </h2>
         <a href="contact.html">
          <i class="icon-envelope">
          </i>
         </a>
        </div>
        <div class="col-md-12 content-page">
         <!-- Blog Post Start -->
         <!-- Blog Post End -->
         <body>
          <article class="page sans" id="eba8c297-d298-4b5a-bd79-b54b26fb3527">
           <header>
            <img class="page-cover-image" src="https://live.staticflickr.com/65535/49972266056_ffd94f728d_z.jpg" style="object-position:center 18.54%"/>
            <h1 class="page-title">
             [UE4/OPENCV] 通過OPENCV讀取Webcam畫面
            </h1>
            <table class="properties">
             <tbody>
              <tr class="property-row property-row-created_time">
               <th>
                <span class="icon property-icon">
                 <svg class="typesCreatedAt" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.4);flex-shrink:0;-webkit-backface-visibility:hidden" viewbox="0 0 14 14">
                  <path d="M6.98643729,14.0000972 C5.19579566,14.0000972 3.40419152,13.3106896 2.04245843,11.9323606 C-0.681017475,9.21200555 -0.680780251,4.76029539 2.04293482,2.04012507 C4.76664406,-0.68004331 9.22427509,-0.68004331 11.9480135,2.04013479 C13.272481,3.36277455 14,5.1330091 14,6.99552762 C14,8.87640182 13.2721894,10.6285043 11.9480135,11.9509302 C10.5679344,13.3105924 8.77756503,14.0000972 6.98643729,14.0000972 Z M10.2705296,7.00913883 L10.2705296,8.46099754 L10.2705296,8.65543362 L10.076181,8.65543362 L8.6543739,8.65543362 L5.72059514,8.65543362 L5.52619796,8.65543362 L5.52619796,8.46099754 L5.52619796,5.52541044 L5.52619796,3.37946773 L5.52619796,3.18502193 L5.72059514,3.18502193 L7.17253164,3.18502193 L7.36692883,3.18502193 L7.36692883,3.37946773 L7.36692883,6.81467358 L10.076181,6.81467358 L10.2705296,6.81467358 L10.2705296,7.00913883 Z M12.1601539,6.99552762 C12.1601539,5.61697497 11.6190112,4.32597154 10.6393933,3.34769528 C8.63253764,1.34336744 5.35197452,1.34061603 3.34153136,3.33944106 C3.33868273,3.34219247 3.33607716,3.34494388 3.33322852,3.34769528 C1.32397148,5.35459953 1.32372842,8.63641682 3.33322852,10.6433794 C5.34295224,12.6504489 8.62968901,12.6504489 10.6393933,10.6433794 C11.6190112,9.66506426 12.1601539,8.37408027 12.1601539,6.99552762 Z">
                  </path>
                 </svg>
                </span>
                Created
               </th>
               <td>
                <time>
                 @Jun 4, 2020 6:39 PM
                </time>
               </td>
              </tr>
              <tr class="property-row property-row-multi_select">
               <th>
                <span class="icon property-icon">
                 <svg class="typesMultipleSelect" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.4);flex-shrink:0;-webkit-backface-visibility:hidden" viewbox="0 0 14 14">
                  <path d="M4,3 C4,2.447715 4.447715,2 5,2 L12,2 C12.5523,2 13,2.447716 13,3 C13,3.55228 12.5523,4 12,4 L5,4 C4.447715,4 4,3.55228 4,3 Z M4,7 C4,6.447715 4.447715,6 5,6 L12,6 C12.5523,6 13,6.447716 13,7 C13,7.55228 12.5523,8 12,8 L5,8 C4.447715,8 4,7.55228 4,7 Z M4,11 C4,10.447715 4.447715,10 5,10 L12,10 C12.5523,10 13,10.447716 13,11 C13,11.55228 12.5523,12 12,12 L5,12 C4.447715,12 4,11.55228 4,11 Z M2,4 C1.44771525,4 1,3.55228475 1,3 C1,2.44771525 1.44771525,2 2,2 C2.55228475,2 3,2.44771525 3,3 C3,3.55228475 2.55228475,4 2,4 Z M2,8 C1.44771525,8 1,7.55228475 1,7 C1,6.44771525 1.44771525,6 2,6 C2.55228475,6 3,6.44771525 3,7 C3,7.55228475 2.55228475,8 2,8 Z M2,12 C1.44771525,12 1,11.5522847 1,11 C1,10.4477153 1.44771525,10 2,10 C2.55228475,10 3,10.4477153 3,11 C3,11.5522847 2.55228475,12 2,12 Z">
                  </path>
                 </svg>
                </span>
                Tags
               </th>
               <td>
                <span class="selected-value select-value-color-pink">
                 C++
                </span>
                <span class="selected-value select-value-color-gray">
                 UE4
                </span>
               </td>
              </tr>
             </tbody>
            </table>
           </header>
           <div class="page-body">
            <blockquote class="" id="b7cbc137-278a-445d-bcb5-a2ddf1f98ffa">
             源文檔:
             <a href="https://wiki.unrealengine.com/Detailed_Account_Of_Integrating_OpenCV_Into_UE4_With_VS2017">
              https://wiki.unrealengine.com/Detailed_Account_Of_Integrating_OpenCV_Into_UE4_With_VS2017
             </a>
             流程主要參考這篇，但隨著版本更新，小部分代碼有了改變，因此寫下這篇作為紀錄
以下使用UE4.22、OpenCV 3.4.6、VS2017
            </blockquote>
            <h1 class="" id="db5248a0-2e96-47ea-91d2-8ae3a1d42466">
             下載OpenCV
            </h1>
            <p class="" id="6826d1df-9a87-4bd4-a0a8-2995c827ac01">
             選擇自己的作業系統下載並解壓縮
            </p>
            <figure id="dded0d7e-a313-4487-ba44-c1606320abbf">
             <a class="bookmark source" href="https://opencv.org/releases/">
              <div class="bookmark-info">
               <div class="bookmark-text">
                <div class="bookmark-title">
                 Releases
                </div>
               </div>
               <div class="bookmark-href">
                <img class="icon bookmark-icon" src="https://opencv.org/wp-content/uploads/2019/11/favicon.ico"/>
                https://opencv.org/releases/
               </div>
              </div>
              <img class="bookmark-image" src="https://opencv.org/wp-content/uploads/2019/02/opencv-logo-1.png"/>
             </a>
            </figure>
            <h1 class="" id="b56aac3e-7812-4fd9-a62b-78a9bbde7f3f">
             複製OpenCV檔案至UE4 Project
            </h1>
            <p class="" id="68340a1d-7c18-4339-85db-2be21d9004bf">
             打開UE4 launcher，建立一個新的C++ project，選擇basic code模板
            </p>
            <p class="" id="12fedb01-0500-418b-954f-dac79751a272">
             在project檔案下建立一個新的資料夾
             <strong>
              '/ThirdParty'
             </strong>
            </p>
            <figure class="image" id="88008b5f-2e50-46c6-8945-9640c5c416cc">
             <a href="https://live.staticflickr.com/65535/49972177771_584ff72cf6_z.jpg">
              <img src="https://live.staticflickr.com/65535/49972177771_584ff72cf6_z.jpg"/>
             </a>
            </figure>
            <p class="" id="53255d5f-ec6a-48bb-9f49-5387364433d1">
             再依照下圖依序建立資料夾
            </p>
            <figure class="image" id="3b024de6-bf45-4f68-8285-7e677ea74365">
             <a href="https://live.staticflickr.com/65535/49972369503_66d5bec020_c.jpg">
              <img src="https://live.staticflickr.com/65535/49972369503_66d5bec020_c.jpg"/>
             </a>
            </figure>
            <p class="" id="72e8508c-5ea1-4433-b65f-314c0775262a">
             複製剛剛解壓縮的OpenCV
             <strong>
              '/opencv/build/include'
             </strong>
             路徑中的所有檔案複製到
            </p>
            <p class="" id="853d703b-fbd3-4524-aea2-934770a810f2">
             UE4 Project
             <strong>
              '/ThirdParty/OpenCV/Includes'
             </strong>
            </p>
            <p class="" id="e81b6da5-e97d-4de8-9ca9-23658a6b5b30">
            </p>
            <p class="" id="4bb3cecb-87e9-4855-b71b-433858c9ba2c">
             接著複製OpenCV
             <strong>
              '/opencv/build/x64/vc14/lib'
             </strong>
             路徑中
             <strong>
              'opencv_world346.lib'
             </strong>
            </p>
            <p class="" id="abd7d61a-2890-4999-a1a3-46d16d7d2451">
             及
             <strong>
              '/opencv/build/x64/vc14/bin'
             </strong>
             路徑中
             <strong>
              'opencv_world346.dll'
             </strong>
             和
             <strong>
              'opencv_ffmpeg346_64.dll'
             </strong>
             到
            </p>
            <p class="" id="2aa19872-177b-4134-b6d7-e45e799223bc">
             UE4 Project
             <strong>
              '/ThirdParty/OpenCV/Libraries/Win64'
             </strong>
            </p>
            <h1 class="" id="6cab9f43-c73d-4f29-b6e3-f18b75fc4354">
             修改 ProjectName.build.cs
            </h1>
            <p class="" id="356b2210-9457-4c5f-b022-da6825dc57e7">
             首先，include '
             <a href="http://system.io/">
              System.IO
             </a>
             '
            </p>
            <pre class="code" id="4f716b84-e6bd-47e8-bdfa-c36606678271"><code>using System.IO;</code></pre>
            <p class="" id="35e9bf72-3bfc-4e8c-bab8-de30eddad751">
             在ModuleRules class中宣告'ThirdPartyPath'並獲取路徑
            </p>
            <pre class="code" id="caa889b0-df96-47d6-a3c6-0dc6f54c29cd"><code>private string ThirdPartyPath
    {
        get { return Path.GetFullPath(Path.Combine(ModuleDirectory, "../../ThirdParty")); }
    }</code></pre>
            <p class="" id="acd72b64-ecd0-4815-9ab0-d3690bf6b277">
             在PrivateDependencyModule中加入'RHI'、'RenderCore'，後面FUpdateTextureRegion2D才有辦法使用
            </p>
            <pre class="code" id="dbf5373c-df80-411b-9c64-620f302dabcb"><code>PrivateDependencyModuleNames.AddRange(new string[] { "RHI", "RenderCore" });</code></pre>
            <p class="" id="23e51240-e181-4463-adf1-4d7b746797cf">
             最後在Constructor添加獲取第三方庫代碼
            </p>
            <pre class="code" id="f5987b62-c1f8-4f62-a12f-5ddb1c83f912"><code>string OpenCVPath = Path.Combine(ThirdPartyPath, "OpenCV");

if (Target.Platform == UnrealTargetPlatform.Win64)
        {
            string OpenCVIncludePath = Path.Combine(OpenCVPath, "Includes");
            string OpenCVLibPath = Path.Combine(OpenCVPath, "Libraries", "Win64");

            PublicIncludePaths.Add(OpenCVIncludePath);
            PublicLibraryPaths.Add(OpenCVLibPath);

            //Add Static Libraries
            PublicAdditionalLibraries.Add("opencv_world346.lib");
            
            //Add Dynamic Libraries
            PublicDelayLoadDLLs.Add("opencv_world346.dll");
            PublicDelayLoadDLLs.Add("opencv_ffmpeg346_64.dll");
        }</code></pre>
            <p class="" id="7e017bbf-157e-4c36-975c-d5966e94eecb">
             完整代碼如下:
            </p>
            <p class="" id="82ca117d-1a68-463b-80ce-43e9815ada7b">
             **若編譯出現錯誤，請確認路徑及OpenCV版本是否正確
            </p>
            <pre class="code" id="f6bc4356-f0be-4cec-b852-95448141306e"><code>using System.IO;
using UnrealBuildTool;

public class CV : ModuleRules
{
    private string ThirdPartyPath
    {
        get { return Path.GetFullPath(Path.Combine(ModuleDirectory, "../../ThirdParty")); }
    }

    public CV(ReadOnlyTargetRules Target) : base(Target)
    {
        PCHUsage = PCHUsageMode.UseExplicitOrSharedPCHs;

        PublicDependencyModuleNames.AddRange(new string[] { "Core", "CoreUObject", "Engine", "InputCore" });

        PrivateDependencyModuleNames.AddRange(new string[] { "RHI", "RenderCore" });

        // Uncomment if you are using Slate UI
        // PrivateDependencyModuleNames.AddRange(new string[] { "Slate", "SlateCore" });

        // Uncomment if you are using online features
        // PrivateDependencyModuleNames.Add("OnlineSubsystem");

        // To include OnlineSubsystemSteam, add it to the plugins section in your uproject file with the Enabled attribute set to true

        string OpenCVPath = Path.Combine(ThirdPartyPath, "OpenCV");

        if (Target.Platform == UnrealTargetPlatform.Win64)
        {
            string OpenCVIncludePath = Path.Combine(OpenCVPath, "Includes");
            string OpenCVLibPath = Path.Combine(OpenCVPath, "Libraries", "Win64");

            PublicIncludePaths.Add(OpenCVIncludePath);
            PublicLibraryPaths.Add(OpenCVLibPath);

            //Add Static Libraries
            PublicAdditionalLibraries.Add("opencv_world346.lib");
            
            //Add Dynamic Libraries
            PublicDelayLoadDLLs.Add("opencv_world346.dll");
            PublicDelayLoadDLLs.Add("opencv_ffmpeg346_64.dll");
        }
    }
}</code></pre>
            <h1 class="" id="7e797617-258f-4c3a-8a68-8a85a4dc219f">
             加入動態庫
            </h1>
            <p class="" id="9f0dcfcb-729b-47d6-8983-ffccb58d5a67">
             將
             <strong>
              'opencv_world346.dll'
             </strong>
             和
             <strong>
              'opencv_ffmpeg346_64.dll'
             </strong>
             複製到
            </p>
            <p class="" id="419f2a5c-f62b-406f-9c32-4799e56162d6">
             UE4 Project
             <strong>
              ‘/Binaries/Win64’
             </strong>
            </p>
            <figure class="image" id="68d17a19-66b7-4c3f-86d1-f9c5816c4903">
             <a href="https://live.staticflickr.com/65535/49972457577_3ac8d9ba1c_z.jpg">
              <img src="https://live.staticflickr.com/65535/49972457577_3ac8d9ba1c_z.jpg"/>
             </a>
            </figure>
            <h1 class="" id="062296d6-155e-478f-804e-acf8fe6f8631">
             配置Project屬性
            </h1>
            <p class="" id="f05996f1-0d08-47b7-9349-4e31371b710c">
             右鍵項目屬性——NMake——IntelliSense——包含搜索路徑中添加
             <strong>
              '..\..\ThirdParty\OpenCV\Includes'
             </strong>
            </p>
            <figure class="image" id="ef39881b-8ba4-4df6-81b7-b69c7638bb5a">
             <a href="https://upload.cc/i1/2020/06/06/w9XI2W.png">
              <img src="https://upload.cc/i1/2020/06/06/w9XI2W.png" style="width:336px"/>
             </a>
            </figure>
            <h1 class="" id="8f0c86f3-a009-4a23-ae7c-c55b5064f1ec">
             添加WebCamReader Class
            </h1>
            <p class="" id="cdf49414-8178-4ca1-a57e-74eb4568e276">
             現在已經可以在UE4使用OpenCV庫了。新增一個C++ Class，繼承Actor並取名為'WebCamReader'。接著到VS添加以下代碼
            </p>
            <h3 class="" id="cef66bd7-c9e9-4737-8380-ea6077505195">
             Header
            </h3>
            <pre class="code" id="f56d3390-0139-43bc-9e90-ef6ed3360ee1"><code>// Fill out your copyright notice in the Description page of Project Settings.

#pragma once

#include "opencv2/core.hpp"
#include "opencv2/highgui.hpp" 
#include "opencv2/imgproc.hpp"
#include "opencv2/videoio.hpp"
#include "CoreMinimal.h"
#include "GameFramework/Actor.h"
#include "Runtime/Engine/Classes/Engine/Texture2D.h"
#include "WebCamReader.generated.h"

UCLASS()
class CV_API AWebCamReader : public AActor
{
 GENERATED_BODY()
 
public: 
 AWebCamReader();

 virtual void BeginPlay() override;

 virtual void Tick(float DeltaTime) override;

 // The device ID opened by the Video Stream
 UPROPERTY(BlueprintReadWrite, EditAnywhere, Category = Webcam)
 int32 CameraID;

 // If the webcam images should be resized every frame
 UPROPERTY(BlueprintReadWrite, EditAnywhere, Category = Webcam)
 bool ShouldResize;

 // The targeted resize width and height (width, height)
 UPROPERTY(BlueprintReadWrite, EditAnywhere, Category = Webcam)
 FVector2D ResizeDeminsions;

 // The rate at which the color data array and video texture is updated (in frames per second)
 UPROPERTY(BlueprintReadWrite, EditAnywhere, Category = Webcam)
 float RefreshRate;

 // The refresh timer
 UPROPERTY(BlueprintReadWrite, Category = Webcam)
 float RefreshTimer;

 // Blueprint Event called every time the video frame is updated
 UFUNCTION(BlueprintImplementableEvent, Category = Webcam)
 void OnNextVideoFrame();

 // OpenCV fields
 cv::Mat frame;
 cv::VideoCapture stream;
 cv::Size size;

 // OpenCV prototypes
 void UpdateFrame();
 void UpdateTexture();

 // If the stream has succesfully opened yet
 UPROPERTY(BlueprintReadOnly, Category = Webcam)
 bool isStreamOpen;

 // The videos width and height (width, height)
 UPROPERTY(BlueprintReadWrite, Category = Webcam)
 FVector2D VideoSize;

 // The current video frame's corresponding texture
 UPROPERTY(BlueprintReadOnly, Category = Webcam)
 UTexture2D* VideoTexture;

 // The current data array
 UPROPERTY(BlueprintReadOnly, Category = Webcam)
 TArray Data;

protected:

 // Use this function to update the texture rects you want to change:
 // NOTE: There is a method called UpdateTextureRegions in UTexture2D but it is compiled WITH_EDITOR and is not marked as ENGINE_API so it cannot be linked
 // from plugins.
 // FROM: https://wiki.unrealengine.com/Dynamic_Textures
 void UpdateTextureRegions(UTexture2D* Texture, int32 MipIndex, uint32 NumRegions, FUpdateTextureRegion2D* Regions, uint32 SrcPitch, uint32 SrcBpp, uint8* SrcData, bool bFreeData);

 // Pointer to update texture region 2D struct
 FUpdateTextureRegion2D* VideoUpdateTextureRegion;

};</code></pre>
            <h3 class="" id="0380e612-cf7c-4f85-85f7-943f80b04162">
             Source
            </h3>
            <pre class="code" id="c3df2b10-100f-44a7-8910-a51d6165e9a1"><code>// Fill out your copyright notice in the Description page of Project Settings.

#include "WebCamReader.h"
#include "CV.h" 
#include 

// Sets default values
AWebCamReader::AWebCamReader()
{
  // Set this actor to call Tick() every frame.  You can turn this off to improve performance if you don't need it.
 PrimaryActorTick.bCanEverTick = true;

 // Initialize OpenCV and webcam properties
 CameraID = 0;
 RefreshRate = 15;
 isStreamOpen = false;
 VideoSize = FVector2D(0, 0);
 ShouldResize = false;
 ResizeDeminsions = FVector2D(320 , 240);
 RefreshTimer = 0.0f;
 stream = cv::VideoCapture();
 frame = cv::Mat();
}

// Called when the game starts or when spawned
void AWebCamReader::BeginPlay()
{
 Super::BeginPlay();
 
 // Open the stream
 stream.open(CameraID);
 if (stream.isOpened())
 {
  // Initialize stream
  isStreamOpen = true;
  UpdateFrame();
  VideoSize = FVector2D(frame.cols, frame.rows);
  size = cv::Size(ResizeDeminsions.X, ResizeDeminsions.Y);
  VideoTexture = UTexture2D::CreateTransient(VideoSize.X , VideoSize.Y );
  VideoTexture-&gt;UpdateResource();
  VideoUpdateTextureRegion = new FUpdateTextureRegion2D(0, 0, 0, 0, VideoSize.X, VideoSize.Y);

  // Initialize data array
  Data.Init(FColor(0, 0, 0, 255), VideoSize.X * VideoSize.Y);

  // Do first frame
  UpdateTexture();
  OnNextVideoFrame();
 }
}

// Called every frame
void AWebCamReader::Tick(float DeltaTime)
{
 Super::Tick(DeltaTime);

 RefreshTimer += DeltaTime;
 if (isStreamOpen &amp;&amp; RefreshTimer &gt;= 1.0f / RefreshRate)
 {
  RefreshTimer -= 1.0f / RefreshRate;
  UpdateFrame();
  UpdateTexture();
  OnNextVideoFrame();
 }
}

void AWebCamReader::UpdateFrame()
{
 if (stream.isOpened())
 {
  stream.read(frame);
  if (ShouldResize)
  {
   cv::resize(frame, frame, size);
  }
 }
 else {
  isStreamOpen = false;
 }
}

void AWebCamReader::UpdateTexture()
{
 if (isStreamOpen &amp;&amp; frame.data)
 {
  // Copy Mat data to Data array
  for (int y = 0; y &lt; VideoSize.Y; y++)
  {
   for (int x = 0; x &lt; VideoSize.X; x++)
   {
    int i = x + (y * VideoSize.X);
    Data[i].B = frame.data[i * 3 + 0];
    Data[i].G = frame.data[i * 3 + 1];
    Data[i].R = frame.data[i * 3 + 2];
   }
  }

  // Update texture 2D
  UpdateTextureRegions(VideoTexture, (int32)0, (uint32)1, VideoUpdateTextureRegion, (uint32)(4 * VideoSize.X), (uint32)4, (uint8*)Data.GetData(), false);
 }
}

void AWebCamReader::UpdateTextureRegions(UTexture2D* Texture, int32 MipIndex, uint32 NumRegions, FUpdateTextureRegion2D* Regions, uint32 SrcPitch, uint32 SrcBpp, uint8* SrcData, bool bFreeData)
{
 if (Texture-&gt;Resource)
 {
  struct FUpdateTextureRegionsData
  {
   FTexture2DResource* Texture2DResource;
   int32 MipIndex;
   uint32 NumRegions;
   FUpdateTextureRegion2D* Regions;
   uint32 SrcPitch;
   uint32 SrcBpp;
   uint8* SrcData;
  };

  FUpdateTextureRegionsData* RegionData = new FUpdateTextureRegionsData;

  RegionData-&gt;Texture2DResource = (FTexture2DResource*)Texture-&gt;Resource;
  RegionData-&gt;MipIndex = MipIndex;
  RegionData-&gt;NumRegions = NumRegions;
  RegionData-&gt;Regions = Regions;
  RegionData-&gt;SrcPitch = SrcPitch;
  RegionData-&gt;SrcBpp = SrcBpp;
  RegionData-&gt;SrcData = SrcData;

  ENQUEUE_RENDER_COMMAND(UpdateTextureRegionsData)(
  [RegionData, bFreeData](FRHICommandListImmediate&amp; RHICmdList)
  {
   for (uint32 RegionIndex = 0; RegionIndex &lt; RegionData-&gt;NumRegions; ++RegionIndex)
   {
    int32 CurrentFirstMip = RegionData-&gt;Texture2DResource-&gt;GetCurrentFirstMip();
    if (RegionData-&gt;MipIndex &gt;= CurrentFirstMip)
    {
     RHIUpdateTexture2D(
      RegionData-&gt;Texture2DResource-&gt;GetTexture2DRHI(),
      RegionData-&gt;MipIndex - CurrentFirstMip,
      RegionData-&gt;Regions[RegionIndex],
      RegionData-&gt;SrcPitch,
      RegionData-&gt;SrcData
      + RegionData-&gt;Regions[RegionIndex].SrcY * RegionData-&gt;SrcPitch
      + RegionData-&gt;Regions[RegionIndex].SrcX * RegionData-&gt;SrcBpp
     );
    }
   }
   if (bFreeData)
   {
    FMemory::Free(RegionData-&gt;Regions);
    FMemory::Free(RegionData-&gt;SrcData);
   }
   delete RegionData;
  });
 }
}</code></pre>
            <p class="" id="2a36fe3d-51d8-4011-a41d-c73c1d5c51c6">
            </p>
            <blockquote class="" id="da4a6107-8165-4469-b68a-2066ab437b7f">
             Note:
             <strong>
              ‘ENQUEUE_UNIQUE_RENDER_COMMAND_TWOPARAMETER’
             </strong>
             在4.22版本要改成使用
             <strong>
              'ENQUEUE_RENDER_COMMAND'
             </strong>
             ，這邊我是使用4.22，若是之前版本則不用更改(代碼參考源文檔)
            </blockquote>
            <figure class="image" id="f7798953-5b8d-4310-8927-f7078dd5fa60">
             <a href="https://live.staticflickr.com/65535/49972527517_23382c723b_b.jpg">
              <img src="https://live.staticflickr.com/65535/49972527517_23382c723b_b.jpg"/>
             </a>
            </figure>
            <h1 class="" id="0dfea40c-0698-4fc1-a7f1-07a693e1f06c">
             Blueprint中使用
            </h1>
            <p class="" id="be9cd31a-fda6-4767-bd78-e828ad8ea45d">
             新增一個Material命名為M_Webcam。ShadeMode設定Unlit，新增一個Texture parameter命名為Texture並接上Emissive Color
            </p>
            <figure class="image" id="b1f25908-a8ca-4684-b59a-871f450d3587">
             <a href="https://upload.cc/i1/2020/06/06/O3aVjd.png">
              <img src="https://upload.cc/i1/2020/06/06/O3aVjd.png" style="width:384px"/>
             </a>
            </figure>
            <p class="" id="9abd891d-617a-4c08-adc0-bb330af5e1d9">
             新增一個blueprint命名為BP_WebCamBillboard，Class繼承AWebCamReader。
            </p>
            <p class="" id="e3328273-3794-47cd-b67e-0348f270ad2e">
            </p>
            <p class="" id="8da8ceca-6c43-4ff9-91fc-6989af05b80b">
             打開BP_WebCamBillboard並新增一個Cube Static Mesh Component，攝像頭獲取到的textures將渲染在這上面。
            </p>
            <p class="" id="59081f6b-bd0a-4427-a372-9793a1d8c8b3">
            </p>
            <p class="" id="c096c6ef-c938-4739-a4b7-78cb7a1a35f9">
             新增一個 Material Instance Dynamic變數命名為Dynamic Material，並照上圖配置藍圖
            </p>
            <figure class="image" id="2cb5852d-b515-42f4-9169-cc36673bcdd9">
             <a href="https://live.staticflickr.com/65535/49972266071_794f3f35f3_b.jpg">
              <img src="https://live.staticflickr.com/65535/49972266071_794f3f35f3_b.jpg"/>
             </a>
            </figure>
            <p class="" id="e51a4c22-4abb-4aca-9c70-1c8f35b43d7f">
             將BP_WebCamBillboard放進level，Play就可以看到畫面囉，cheers!
            </p>
            <figure class="image" id="c03ff46e-b02d-4ddd-a717-c4c8f5d43a77">
             <a href="https://live.staticflickr.com/65535/49972266056_ffd94f728d_z.jpg">
              <img src="https://live.staticflickr.com/65535/49972266056_ffd94f728d_z.jpg"/>
             </a>
            </figure>
            <h1 class="" id="0f2cfd1c-7918-4249-8771-22a5ce955d51">
             References
            </h1>
            <figure id="960160d3-8dff-437d-afe1-640154517b08">
             <a class="bookmark source" href="https://wiki.unrealengine.com/Detailed_Account_Of_Integrating_OpenCV_Into_UE4_With_VS2017">
              <div class="bookmark-info">
               <div class="bookmark-text">
                <div class="bookmark-title">
                 A new, community-hosted Unreal Engine Wiki
                </div>
                <div class="bookmark-description">
                 After over a year in maintenance mode, the official Unreal Engine Wiki is now permanently offline. These resources now live on a new community-run Unreal Engine Community Wiki - ue4community.wiki (https://ue4community.wiki)! You will be able to find content from the official Unreal Engine Wiki at ue4community.wiki/legacy
                </div>
               </div>
               <div class="bookmark-href">
                <img class="icon bookmark-icon" src="https://forums.unrealengine.com/favicon.ico"/>
                https://wiki.unrealengine.com/Detailed_Account_Of_Integrating_OpenCV_Into_UE4_With_VS2017
               </div>
              </div>
              <img class="bookmark-image" src="https://forums.unrealengine.com/core/images/default/default_avatar_medium.png"/>
             </a>
            </figure>
           </div>
          </article>
         </body>
         <div class="col-md-12 text-center">
          <!--
          <a class="load-more-button" href="javascript:void(0)" id="load-more-post">
           Load
          </a>
         -->
          <div id="post-end-message">
          </div>
         </div>
        </div>
       </div>
       <!-- Subscribe Form Start -->
       <div class="col-md-8 col-md-offset-2">
        <form action="http://uipasta.us14.list-manage.com/subscribe/post?u=854825d502cdc101233c08a21&amp;id=86e84d44b7" id="mc-form" method="post">
         <div class="subscribe-form margin-top-20">
          <input class="text-input" id="mc-email" placeholder="Email Address" type="email"/>
          <button class="submit-btn" type="submit">
           Submit
          </button>
         </div>
         <p>
          Subscribe to my weekly newsletter
         </p>
         <label class="mc-label" for="mc-email">
         </label>
        </form>
       </div>
       <!-- Subscribe Form End -->
      </div>
      <!-- Footer Start -->
      <div class="col-md-12 main-body margin-top-50 footer">
       <footer>
        <ul class="menu-link">
         <li>
          <a href="index.html">
           Home
          </a>
         </li>
         <li>
          <a href="about.html">
           About
          </a>
         </li>
         <li>
          <a href="work.html">
           Work
          </a>
         </li>
         <li>
          <a href="contact.html">
           Contact
          </a>
         </li>
        </ul>
        <p>
         © Copyright 2016 DevBlog. All rights reserved
        </p>
        <!-- UiPasta Credit Start -->
        <div class="uipasta-credit">
         Design By
         <a href="http://www.uipasta.com" target="_blank">
          UiPasta
         </a>
        </div>
        <!-- UiPasta Credit End -->
       </footer>
      </div>
      <!-- Footer End -->
     </div>
     <!-- Blog Post (Right Sidebar) End -->
    </div>
   </div>
  </div>
  <!-- Back to Top Start -->
  <a class="scroll-to-top" href="#">
   <i class="fa fa-long-arrow-up">
   </i>
  </a>
  <!-- Back to Top End -->
  <!-- All Javascript Plugins  -->
  <script src="style/js/jquery.min.js" type="text/javascript">
  </script>
  <script src="style/js/plugin.js" type="text/javascript">
  </script>
  <!-- Main Javascript File  -->
  <script src="style/js/scripts.js" type="text/javascript">
  </script>
 </body>
</html>
